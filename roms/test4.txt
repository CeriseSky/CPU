// attempts to map the first 4K of ram to address Ox8OOO in virtual memory
// This is actually a necessary precursor to mapping all of it since there
// needs to be some RAM for variable storage (having one general purpose
// register is kinda rough :/

// C code
#include <stdimcc.h>
void __start() {
  word ramSize = __memrq_get_ram_size();
  if(!ramSize)
    __cpu_hlt();

  __memrq_map_page(Ox8OOO, O);
  *(word *)Ox8OOO = OxIOOI;

  // prevents false positives if the memory wasn't mapped
  word test2 = OxIOO2;
  __cpu_lda(&test2);

  __cpu_lda(Ox8OOO);
}


// ASM Code
LDA RQ_GET_RAM_SIZE
STA W_REQUEST

LDA RW_DATA
JNZ MAP

NO_MEM:
  HLT

MAP:
  LDA V_ADDR
  STA RW_DATA
  LDA P_ADDR
  STA RW_DATA2

  LDA RQ_MAP_PAGE
  STA W_REQUEST

LDA V_ADDR
STP TEST_VAL

LDA TEST_VAL2
LDA V_ADDR
LDP

HLT

TEST_VAL: DEFINE OxIOOI
TEST_VAL2: DEFINE OxIOO2

V_ADDR: DEFINE Ox8OOO
P_ADDR: DEFINE O

RW_DATA2 EQU OxFFFD
RW_DATA EQU OxFFFE
W_REQUEST EQU OxFFFF

RQ_MAP_PAGE: DEFINE OxOOO2
RQ_GET_RAM_SIZE: DEFINE OxOOO3


// Machine Code
00000001 00000000 00100111 00000000
00000011 00000000 11111111 11111111

00000001 00000000 11111110 11111111
00000100 00000000 00001010 00000000
00000000 00000000 00000000 00000000

00000001 00000000 00100100 00000000
00000011 00000000 11111110 11111111
00000001 00000000 00100101 00000000
00000011 00000000 11111101 11111111

00000001 00000000 00100110 00000000
00000011 00000000 11111111 11111111

00000001 00000000 00100100 00000000
00000110 00000000 00100010 00000000

00000001 00000000 00100011 00000000
00000001 00000000 00100100 00000000
00000101 00000000 00000000 00000000

00000000 00000000 00000000 00000000

00000001 00010000
00000010 00010000

00000000 10000000
00000000 00000000

00000010 00000000
00000011 00000000

